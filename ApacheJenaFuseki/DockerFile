# Stage 1: Build the project
FROM maven:3.8.4-openjdk-17 AS build

# Set the working directory
WORKDIR /app

# Copy the pom.xml and the source code
COPY pom.xml .
COPY src ./src

# Run Maven to build the project and generate the JAR
RUN mvn clean package -DskipTests

# Stage 2: Prepare the runtime environment
FROM openjdk:17-jre-slim

# Install Fuseki
RUN apt-get update && apt-get install -y \
    wget \
    && wget https://apache.mirrors.lucidnetworks.net/jena/binaries/apache-jena-fuseki-4.7.0.tar.gz \
    && tar -xzf apache-jena-fuseki-4.7.0.tar.gz \
    && mv apache-jena-fuseki-4.7.0 /opt/fuseki \
    && rm apache-jena-fuseki-4.7.0.tar.gz \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Copy the JAR file from the build stage
COPY --from=build /app/ApacheJena/demo/target/fuseki-server-1.0-SNAPSHOT.jar /app/fuseki-server.jar

# Set the working directory
WORKDIR /opt/fuseki

# Expose port 3030 for Fuseki
EXPOSE 3030

# Configure the command to run Fuseki with the JAR file
CMD ["/opt/fuseki/fuseki-server", "--config=/app/fuseki-server.jar"]
